<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1">
    <title>RoErJo | Upload/Download A File With Dropbox in an Android App</title>

    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,700,100%7CRoboto:400,700,300,100' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="../../../css/normalize.css">

    <link rel="stylesheet" type="text/css" href="../../../css/post.css">
    <script type="text/javascript">
        function showMenu() {
            var x = document.getElementById("responsive");
            if (x.style.display != "block") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
            }
        }
    </script>
</head>
<body>

    <header class="head">
        <div class="container">
            <a href="/"><h1>RoErJo</h1></a>
            <nav>
                <ul class="" id="navbar">
                    <li><a href="/#about">About</a></li>
                    <li><a href="/#work">Projects</a></li>
                    <li><a href="/#moreAbout">Learn More</a></li>
                    <li class="icon"><a href="javascript:void(0);" onclick="showMenu()">&#9776;</a></li>
                </ul>
            </nav>
            <ul class="hiddenNav" id="responsive">
                    <li><a href="#about">About</a></li>
                    <li><a href="#work">Projects</a></li>
                    <li><a href="#moreAbout">Learn More</a></li>
            </ul>
        </div>          
    </header>
	
	<div class="container">
		<article>
    		<div class="postHead">
				<h1>Upload/Download A File With Dropbox in an Android App</h1>
				<p class="meta">09 Apr 2017</p>
			</div>
			<div class="post">
			  <h2>Background</h2>

<p>
I was recently working on an Android app that would be using Dropbox to sync
a JSON file with another app. I found several tutorials about uploading a file
using Dropbox's V2 API, but the pickings were slim on the download process. This
was the first Android app I've developed and my first time using Java, so please
excuse my shortcomings in the code. With that said, this does work! So if you're 
looking for a way to upload and download a file in the background read on.
</p>

<h2>Setup Dropbox</h2>

<p>
First, we need to register an app with Dropbox and get an app key. Head over to
the Dropbox developer area, <a href="https://www.dropbox.com/developers">Dropbox Developer</a> 
, and if you don't already have an account go ahead and create a new one.
</p>

<p><img src="/img/dropbox/dropboxdevmain.png" alt="Alt_text" /></p>

<p>
Click on 'My apps' in the upper left and select the 'Create app' button. You will
then be asked to fill out some options. I don't know anything about Dropbox Business
, so this tutorial will just be using the regular Dropbox API. Select the type of 
access your app will need, preferably just to one folder, and then select a name.
</p>

<p><img src="/img/dropbox/dropboxappoptions.png" alt="Alt_text" /></p>

<p>
The next page you see will contain settings for your Dropbox app. The app key is 
what we are most interested in at this point, so copy that and have it ready to 
paste into our Android app.
</p>

<p><img src="/img/dropbox/dropboxsettings.png" alt="Alt_text" /></p>

<h2>Android Setup</h2>

<p>
Let's create a new project in Android Studio. I'm leaving the defaults as they are
for this first section; you can adjust as needed. 
</p>

<p><img src="/img/dropbox/newproject.png" alt="Alt_text" /></p>

<p>
I want this to be able to run back on JellyBean devices so I selected API 17.
</p>

<p><img src="/img/dropbox/apiselect.png" alt="Alt_text" /></p>

<p>
I'm selecting a Login Activity, because we want to have the user sign in to Dropbox
when entering the app, so that we can upload/download the JSON file without having 
to ask for permission later on.
</p>

<p><img src="/img/dropbox/selectactivity.png" alt="Alt_text" /></p>

<h2>Let's Do Some Code</h2>

<h3>build.gradle</h3>

<p>
The first thing we will edit is the build.gradle file (the Module:app one). In the
dependencies section add the following line to bring in the Dropbox SDK.
</p>

<pre>
<code>
dependencies {
    ...
    compile 'com.dropbox.core:dropbox-core-sdk:2.0.1'
}
</code>
</pre>

<p>Next we will want to add some package options to avoid a conflict at build time.
Check out this <a href="http://stackoverflow.com/questions/31912459/duplicate-lib-file-copied-in-apk-meta-inf-license-txt-error-in-android-studio#31912566">Stackoverflow answer</a>
for more info on that. Add the following lines in the android section:</p>

<pre>
<code>
android {
...

    packageOptions {
      exclude 'META-INF/LICENSE'
      exclude 'META-INF/LICENSE.txt'
      exclude 'META-INF/NOTICE'
      exclude 'META-INF/NOTICE.txt'
  }
}
</code>
</pre>

<h3>Android Manifest</h3>

<p>
Now we need to edit the manifest file. First, we'll add the permissions the app will
need to access Dropbox and read/write files on the device. Add the following
permissions to your manifest file:
</p>

<pre>
<code>
&lt;uses-permission android:name="android.permission.INTERNET" /&gt;
&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" /&gt;
&lt;uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" /&gt;
</code>
</pre>

<p>
Next, we will register the Dropbox AuthActivity which will allow our Android app
to talk to the Dropbox app. Be sure to add the app key you obtained from Dropbox
to the approriate field. Addi the following under the LoginActivity stuff in the
manifest file.
</p>

<pre>
<code>
&lt;activity
    android:name="com.dropbox.core.android.AuthActivity"
    android:configChanges="orientation|keyboard"
    android:launchMode="singleTask"&gt;
    &lt;intent-filter&gt;
        &lt;!-- Insert your app key after “db-  ...” --&gt;
        &lt;data android:scheme="db-APP_KEY" /&gt;
        &lt;action android:name="android.intent.action.VIEW" /&gt;
        &lt;category android:name="android.intent.category.BROWSABLE" /&gt;
        &lt;category android:name="android.intent.category.DEFAULT" /&gt;
    &lt;/intent-filter&gt;
&lt;/activity&gt;
</code>
</pre>

<p>
Your manifest file should look something like this when you are done.
</p>

<pre>
<code>
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.myapplication"&gt;

    &lt;uses-permission android:name="android.permission.INTERNET" /&gt;
    &lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" /&gt;
    &lt;uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" /&gt;

    &lt;application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/AppTheme"&gt;
        &lt;activity
            android:name=".LoginActivity"
            android:label="@string/app_name"&gt;
            &lt;intent-filter&gt;
                &lt;action android:name="android.intent.action.MAIN" /&gt;

                &lt;category android:name="android.intent.category.LAUNCHER" /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
        &lt;activity
            android:name="com.dropbox.core.android.AuthActivity"
            android:configChanges="orientation|keyboard"
            android:launchMode="singleTask"&gt;
            &lt;intent-filter&gt;

                &lt;!-- Insert your app key after “db-  ...” --&gt;
                &lt;data android:scheme="db-APP KEY GOES HERE" /&gt;

                &lt;action android:name="android.intent.action.VIEW" /&gt;

                &lt;category android:name="android.intent.category.BROWSABLE" /&gt;
                &lt;category android:name="android.intent.category.DEFAULT" /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
        &lt;activity android:name=".MainActivity"&gt;&lt;/activity&gt;
    &lt;/application&gt;

&lt;/manifest&gt;
</code>
</pre>

<h3>strings.xml</h3>

<p>
We need to store our Dropbox app key for other sections to use, and the res/strings.xml
file is a good place to stick that. Add in the following line in that file:
</p>

<pre>
<code>
&lt;string name="APP_KEY"&gt;{insert your app key here}&lt;/string&gt;
</code>
</pre>

<h3>LoginActivity</h3>

<p>
We will be replacing everything in the LoginActivity with the following code. The
only thing you will need to change for your app, is to replace the package name
with your specifice package name at the top of the file and in the
getAccessToken() method. Also, don't worry about the MainActivity and sign_in_button
error; we will be fixing those shortly.
</p>

<pre>
<code>
package com.example.myapplication;


import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;

import com.dropbox.core.android.Auth;

public class LoginActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_login);

        Button SignInButton = (Button) findViewById(R.id.sign_in_button);
        SignInButton.setOnClickListener(new OnClickListener() {
            @Override
            public void onClick(View view) {
                Auth.startOAuth2Authentication(getApplicationContext(), getString(R.string.APP_KEY));
            }
        });
    }

    @Override
    protected void onResume() {
        super.onResume();
        getAccessToken();
    }

    public void getAccessToken() {
        String accessToken = Auth.getOAuth2Token(); //generate Access Token
        if (accessToken != null) {
            //Store accessToken in SharedPreferences
            SharedPreferences prefs = getSharedPreferences("com.example.myapplication", Context.MODE_PRIVATE);
            prefs.edit().putString("access-token", accessToken).apply();

            //Proceed to MainActivity
            Intent intent = new Intent(LoginActivity.this, MainActivity.class);
            startActivity(intent);
        }
    }
}
</code>
</pre>

<p>
Let's go ahead and fix the issue with the button by editing our LoginActivity xml.
Delete everything in that generated file and replace it with the following and also
be sure to replace the context attribute with your specific package name.
</p>

<pre>
<code>
&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context="com.example.myapplication.LoginActivity"&gt;
    &lt;!-- Update package name --&gt;

    &lt;Button
        android:id="@+id/sign_in_button"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Sign In"
        android:layout_centerVertical="true"
        android:layout_centerHorizontal="true" /&gt;
&lt;/RelativeLayout&gt;
</code>
</pre>

<h3>MainActivity</h3>

<p>
Now we can create our MainActivity which will contain two buttons: one to upload
a file and one to download a file.
</p>

<p>
After we create the MainActivity, let's first add in our buttons to the xml. Here
is a layout if you don't won't to make your own:
</p>

<pre>
<code>
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:layout_centerHorizontal="true"
    tools:context="com.example.myapplication.MainActivity"&gt;

    &lt;Button
        android:id="@+id/download"
        android:text="Download"
        android:layout_height="wrap_content"
        android:layout_width="wrap_content"
        android:layout_above="@+id/upload"
        android:layout_centerHorizontal="true"
        android:layout_marginBottom="100dp" /&gt;

    &lt;Button
        android:id="@+id/upload"
        android:text="Upload"
        android:layout_height="wrap_content"
        android:layout_width="wrap_content"
        android:layout_marginBottom="202dp"
        android:layout_alignParentBottom="true"
        android:layout_centerHorizontal="true" /&gt;

&lt;/RelativeLayout&gt;
</code>
</pre>

<p>
Let's make sure everything is working up to this point by running out app. You
should get something similiar after you have logged in and authorized the app 
to access the directory created on Dropbox.
</p>

<p><img src="/img/dropbox/mainscreen.png" alt="Alt_text" /></p>

<h3>Dropbox Client</h3>

<p>
Hopefully your project built fine and you were able to get to your MainActivity. 
We're going to step away from the MainActivity for bit, so that we can setup our
Dropbox client, UploadTask, and DownloadTask. We'll begin with the Dropbox client.
</p>

<p>
Create a new class named DropboxClient and replace everything except your package
name with the following:
</p>

<pre>
<code>
package com.example.myapplication;

import com.dropbox.core.DbxRequestConfig;
import com.dropbox.core.v2.DbxClientV2;

public class DropboxClient {

    public static DbxClientV2 getClient(String ACCESS_TOKEN) {
        DbxRequestConfig config = new DbxRequestConfig("dropbox/sample-app", "en_US");
        return new DbxClientV2(config, ACCESS_TOKEN);
    }
}
</code>
</pre>

<h3>UploadTask</h3>

<p>
Now we'll create a class to handle uploading to Dropbox asyncronously. Create a
class named UploadTask and insert the following code:
</p>

<pre>
<code>
package com.example.myapplication;

import android.content.Context;
import android.os.AsyncTask;
import android.widget.Toast;

import com.dropbox.core.v2.DbxClientV2;
import com.dropbox.core.v2.files.WriteMode;

import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;

public class UploadTask extends AsyncTask {

    private DbxClientV2 dbxClient;
    private File file;
    private Context context;

    UploadTask(DbxClientV2 dbxClient, File file, Context context) {
        this.dbxClient = dbxClient;
        this.file = file;
        this.context = context;
    }

    @Override
    protected Object doInBackground(Object[] params) {
        try {
            InputStream inputStream = new FileInputStream(file);
            dbxClient.files().uploadBuilder("/syncSettings.json")
                    .withMode(WriteMode.OVERWRITE)
                    .uploadAndFinish(inputStream);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }

    @Override
    protected void onPostExecute(Object o) {
        super.onPostExecute(o);
        Toast.makeText(context, "File uploaded successfully", Toast.LENGTH_SHORT).show();
    }
}
</code>
</pre>

<p>
When we upload, we have WriteMode set to OVERWRITE so that the current JSON file
will be updated to what we pushed. I've also hardcoded the filepath where the file
will be stored on Dropbox. 
</p>

<h3>DownloadTask</h3>

<p>
Now we will create the DownloadTask which will take care of retrieving the file
from Dropbox.
</p>

<pre>
<code>
package com.example.myapplication;

import android.content.Context;
import android.os.AsyncTask;
import android.widget.Toast;

import com.dropbox.core.v2.DbxClientV2;
import com.dropbox.core.v2.files.FileMetadata;

import java.io.File;
import java.io.OutputStream;
import java.io.FileOutputStream;


public class DownloadTask extends AsyncTask&lt;FileMetadata, Void, File&gt; {

    private DbxClientV2 dbxClient;
    private Context context;

    DownloadTask(DbxClientV2 dbxClient, Context context) {
        this.dbxClient = dbxClient;
        this.context = context;
    }

    @Override
    protected File doInBackground(FileMetadata... params) {
        try {
            OutputStream outputStream = new FileOutputStream("/sdcard/Download/syncSettings.json");
            dbxClient.files().download("/syncSettings.json").download(outputStream);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }

    @Override
    protected void onPostExecute(File o) {
        super.onPostExecute(o);
        Toast.makeText(context, "File downloaded successfully", Toast.LENGTH_SHORT).show();
    }
}
</code>
</pre>

<p>
The first file path is where want the file saved on our local device. The second is 
where the file is located on Dropbox.
</p>

<h3>JSONConverter</h3>

<p>
This class will create a simple JSON file containing the date it was last modified.
Create a new class and name it JSONConverter and add the following code:
</p>

<pre>
<code>
package com.example.myapplication;


import org.json.JSONObject;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.Writer;
import java.text.SimpleDateFormat;

public class JSONConverter {

    public static void toJSON() {
        try {
            JSONObject jsonObj = new JSONObject();
            String currentDateTime = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS").format(System.currentTimeMillis());
            jsonObj.put("LastUpdated", currentDateTime);
            String data = jsonObj.toString();

            Writer output;
            File file = new File("/sdcard/Download/syncSettings.json");
            output = new BufferedWriter(new FileWriter(file));
            output.write(data);
            output.close();
        }
        catch (Exception e) {
            e.printStackTrace();
        }
    }
}
</code>
</pre>

<h3>MainActivity Part 2</h3>

<p>We're almost done! We need to link in the upload and download tasks, create a 
way to retrieve an access token, and set click listeners on the buttons we made
earlier. Edit your MainActivity class to look like the following:
</p>

<pre>
<code>
package com.example.myapplication;

import android.Manifest;
import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageManager;
import android.support.v4.app.ActivityCompat;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.view.View;
import android.widget.Button;

import java.io.File;

public class MainActivity extends AppCompatActivity {

    private String ACCESS_TOKEN;
    private static final int REQUEST_EXTERNAL_STORAGE = 1;
    private static String[] PERMISSIONS_STORAGE = {
            Manifest.permission.READ_EXTERNAL_STORAGE,
            Manifest.permission.WRITE_EXTERNAL_STORAGE
    };

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        if (!tokenExists()) {
            Intent intent = new Intent(MainActivity.this, LoginActivity.class);
            startActivity(intent);
        }

        verifyStoragePermissions(MainActivity.this);

        ACCESS_TOKEN = retrieveAccessToken();

        Button upload = (Button)findViewById(R.id.upload);
        Button download = (Button)findViewById(R.id.download);

        upload.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                upload();
            }
        });

        download.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                download();
            }
        });
    }

    public static void verifyStoragePermissions(Activity activity) {
        // Check if we have write permission
        int permission = ActivityCompat.checkSelfPermission(activity, Manifest.permission.WRITE_EXTERNAL_STORAGE);

        if (permission != PackageManager.PERMISSION_GRANTED) {
            // We don't have permission so prompt the user
            ActivityCompat.requestPermissions(
                    activity,
                    PERMISSIONS_STORAGE,
                    REQUEST_EXTERNAL_STORAGE
            );
        }
    }



    private void download() {
        try {
            new DownloadTask(DropboxClient.getClient(ACCESS_TOKEN), getApplicationContext()).execute();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void upload() {
        //Create/Edit the file to be uploaded
        JSONConverter.toJSON();
        File file = new File("/sdcard/Download/syncSettings.json");
        try {
            new UploadTask(DropboxClient.getClient(ACCESS_TOKEN), file, getApplicationContext()).execute();
        }
        catch (Exception e) {
            e.printStackTrace();
        }
    }

    //Makes sure the user has a Dropbox access token stored locally
    private boolean tokenExists() {
        SharedPreferences prefs = getSharedPreferences("com.example.myapplication", Context.MODE_PRIVATE);
        String accessToken = prefs.getString("access-token", null);
        return accessToken != null;
    }

    //Retrieves the token so it can be passed to the Dropbox client
    private String retrieveAccessToken() {
        SharedPreferences prefs = getSharedPreferences("com.example.myapplication", Context.MODE_PRIVATE);
        String accessToken = prefs.getString("access-token", null);
        if (accessToken == null) {
            return null;
        } else {
            return accessToken;
        }
    }
}
</code>
</pre>

<h2>Moment Of Truth</h2>

<p>
Everything should be ready for a test run now. Redeploy your app give the upload
button a click. This should create a new JSON file in the location specified on
the device and then upload that file to Dropbox. Verify the file is created by 
going to the specified location in your phone's storage and checking if it is there.
Then, go to Dropbox and verify that you file was uploaded. From your Dropbox home
directory it should be in App/{youAppName}. Success?
</p>

<p><img src="/img/dropbox/dropboxappfolder.png" alt="Alt_text" /></p>

<p>
If everything is working correctly, edit the date and save the file on the Dropbox.
</p>

<p><img src="/img/dropbox/dropboxjson.png" alt="Alt_text" /></p>

<p>
Back in your app, hit the download button and then navigate to where the file is 
stored, open it up and verify the date changed.
</p>

<p>
I hope this tutorial was a help to you!
</p>

			</div>
		</article>
	</div>

	<footer class="footer" id="footer">
	  	<div class="container">
	    	<p>&copy; 2017 RoErJo</p>
	  	</div>
	</footer>

</body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-90488436-1', 'auto');
  ga('send', 'pageview');

</script>
</html>
